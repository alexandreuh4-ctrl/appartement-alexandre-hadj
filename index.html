<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Appartement de Alexandre HADJ</title>
<style>
body {
    font-family: Arial, sans-serif;
    background: linear-gradient(135deg,#667eea,#764ba2);
    margin:0;
    padding:20px;
}
h1 {
    text-align:center;
    color:white;
}
.container {
    max-width:600px;
    margin:auto;
    background:white;
    padding:20px;
    border-radius:15px;
    box-shadow:0 5px 20px rgba(0,0,0,0.3);
}
.stars {
    display:flex;
    justify-content:center;
    margin-top:10px;
}
.stars span {
    font-size:32px;
    cursor:pointer;
    color:#ccc;
    transition: transform 0.2s, color 0.2s;
    margin:0 5px;
}
.stars span:hover,
.stars span.hovered {
    color:gold;
    transform: scale(1.4);
}
.stars span.active {
    color:gold;
    transform: scale(1.2);
}
textarea,input {
    width:100%;
    padding:10px;
    margin-top:10px;
    border-radius:8px;
}
button {
    width:100%;
    padding:10px;
    margin-top:10px;
    border:none;
    background:#667eea;
    color:white;
    font-size:16px;
    border-radius:8px;
    cursor:pointer;
}
.review {
    border-bottom:1px solid #ddd;
    padding:10px 0;
}
.deleteBtn {
    background:red;
    color:white;
    margin-top:5px;
}
.admin {
    margin-top:15px;
    background:#eee;
    padding:10px;
    border-radius:8px;
}
.average {
    text-align:center;
    font-size:20px;
    margin-bottom:10px;
}
#noteSelectionneeDisplay {
    text-align:center; 
    margin-top:5px; 
    font-weight:bold;
}
.review img {
    max-width:100%;
    margin-top:5px;
    border-radius:8px;
}
</style>
</head>

<body>

<h1>Appartement de Alexandre HADJ</h1>

<div class="container">

<div class="average" id="moyenne">Moyenne : 0 ‚≠ê</div>

<input id="nom" placeholder="Ton nom">

<div class="stars" id="stars">
    <span data-note="1">‚≠ê</span>
    <span data-note="2">‚≠ê</span>
    <span data-note="3">‚≠ê</span>
    <span data-note="4">‚≠ê</span>
    <span data-note="5">‚≠ê</span>
</div>
<div id="noteSelectionneeDisplay">Note choisie : 0</div>

<textarea id="commentaire" placeholder="√âcris ton avis (min 10 caract√®res)"></textarea>
<input type="file" id="photo" accept="image/*">
<img id="preview" style="max-width:100%; margin-top:5px; border-radius:8px; display:none;">
<button onclick="ajouterAvis()">Envoyer l'avis</button>

<h2>Avis</h2>
<div id="listeAvis"></div>

<div class="admin">
<h3>Mode admin</h3>
<input type="password" id="password" placeholder="Mot de passe admin">
<button onclick="activerAdmin()">Activer</button>
<button onclick="resetAvis()">Tout supprimer</button>
</div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, push, set, onValue, remove } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";
import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics.js";

// üîπ Configuration Firebase
const firebaseConfig = {
  apiKey: "AIzaSyA-iFaigj6_aHyyvc8wWHDVFpaiX1j-qOU",
  authDomain: "appartement-hadj-alexandre.firebaseapp.com",
  databaseURL: "https://appartement-hadj-alexandre-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "appartement-hadj-alexandre",
  storageBucket: "appartement-hadj-alexandre.firebasestorage.app",
  messagingSenderId: "446838776607",
  appId: "1:446838776607:web:e11dd12a27c52952afc62a",
  measurementId: "G-HFL77GDB15"
};

// üîπ Initialisation
const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
const db = getDatabase(app);
const storage = getStorage(app);

// Variables
let noteSelectionnee = 0;
let admin = false;
const motDePasse = "alexandre123";

// ‚≠ê √âtoiles interactives
const stars = document.querySelectorAll(".stars span");
stars.forEach(star => {
    star.addEventListener("mouseover", () => {
        const note = parseInt(star.dataset.note);
        stars.forEach(s => {
            s.classList.toggle("hovered", parseInt(s.dataset.note) <= note);
        });
    });
    star.addEventListener("mouseout", () => {
        stars.forEach(s => s.classList.remove("hovered"));
    });
    star.addEventListener("click", () => {
        noteSelectionnee = parseInt(star.dataset.note);
        updateStars();
        document.getElementById("noteSelectionneeDisplay").innerText = "Note choisie : " + noteSelectionnee;
    });
});
function updateStars() {
    stars.forEach(s => {
        s.classList.toggle("active", parseInt(s.dataset.note) <= noteSelectionnee);
    });
}

// üîπ Aper√ßu de l'image
const photoInput = document.getElementById("photo");
const previewImg = document.getElementById("preview");

photoInput.addEventListener("change", () => {
    const file = photoInput.files[0];
    if(file){
        const reader = new FileReader();
        reader.onload = e => {
            previewImg.src = e.target.result;
            previewImg.style.display = "block";
        };
        reader.readAsDataURL(file);
    } else {
        previewImg.src = "";
        previewImg.style.display = "none";
    }
});

// üîπ Ajouter un avis avec photo
window.ajouterAvis = async function() {
    const nom = document.getElementById("nom").value.trim();
    const commentaire = document.getElementById("commentaire").value.trim();
    const file = document.getElementById("photo").files[0];

    if(nom === "" || commentaire.length < 10 || noteSelectionnee === 0){
        alert("Remplis tout correctement (10 caract√®res minimum et note).");
        return;
    }

    let photoURL = "";
    if(file){
        try {
            const photoRef = storageRef(storage, 'photos/' + Date.now() + '_' + file.name);
            await uploadBytes(photoRef, file);
            photoURL = await getDownloadURL(photoRef);
        } catch(e){
            console.error(e);
            alert("Erreur lors de l'upload de l'image.");
            return;
        }
    }

    const date = new Date().toLocaleDateString();
    const newAvisRef = push(ref(db, 'avis'));
    set(newAvisRef, {nom, note: noteSelectionnee, commentaire, date, photoURL});

    // Reset formulaire et aper√ßu
    document.getElementById("nom").value = "";
    document.getElementById("commentaire").value = "";
    document.getElementById("photo").value = "";
    previewImg.src = "";
    previewImg.style.display = "none";
    noteSelectionnee = 0;
    updateStars();
    document.getElementById("noteSelectionneeDisplay").innerText = "Note choisie : 0";
};

// üîπ Afficher les avis
function afficherAvis(snapshot) {
    const liste = document.getElementById("listeAvis");
    liste.innerHTML = "";
    const data = snapshot.val();
    let total = 0;
    let count = 0;

    if(data){
        Object.keys(data).forEach(key => {
            const a = data[key];
            total += a.note;
            count++;
            const div = document.createElement("div");
            div.className = "review";
            div.innerHTML = `
                <strong>${a.nom}</strong> - ${a.date}<br>
                ${"‚≠ê".repeat(a.note)}
                <p>${a.commentaire}</p>
                ${a.photoURL ? `<img src="${a.photoURL}">` : ""}
                ${admin ? `<button class="deleteBtn" onclick="supprimerAvis('${key}')">Supprimer</button>` : ""}
            `;
            liste.appendChild(div);
        });
    }

    const moyenne = count ? (total / count).toFixed(1) : 0;
    document.getElementById("moyenne").innerText = "Moyenne : " + moyenne + " ‚≠ê";
}

// üîπ Supprimer un avis
window.supprimerAvis = function(key){
    if(confirm("Supprimer cet avis ?")){
        remove(ref(db, 'avis/' + key));
    }
}

// üîπ Mode admin
window.activerAdmin = function() {
    const pass = document.getElementById("password").value;
    if(pass === motDePasse){
        admin = true;
        alert("Mode admin activ√©");
        document.getElementById("password").value = "";
        onValue(ref(db, 'avis'), snapshot => { afficherAvis(snapshot); }, {onlyOnce:true});
    } else alert("Mot de passe incorrect");
}

// üîπ Tout supprimer
window.resetAvis = function() {
    if(admin && confirm("Tout supprimer ?")){
        remove(ref(db, 'avis'));
    }
}

// üîπ √âcoute en temps r√©el
onValue(ref(db, 'avis'), snapshot => { afficherAvis(snapshot); });
</script>

</body>
</html>
